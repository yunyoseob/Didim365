# âœ¨ ì‹±ê¸€í†¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ í…ŒìŠ¤íŠ¸

## **4.3. @Configurationê³¼ proxyBeanMethods**

@Configurationê³¼ proxyBeanMethodsì— ëŒ€í•´ ì•Œì•„ë³´ê¸° ì „ì— ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•´ë³´ì.

### **4.3.1. @Configuration í…ŒìŠ¤íŠ¸ ì˜ˆì œ**

- Common.java

```java
public class Common {
}
```

- ConfigurationTest.java 

```java
public class ConfigurationTest {
    @Configuration
    static class MyConfig {
        private int cnt;

        @Bean
        Common common() {
            cnt++;
            System.out.println("new Common() : "+cnt+"íšŒ í˜¸ì¶œ");
            Common com = new Common();
            System.out.println("Common ì£¼ì†Œ : "+com);
            return com;
        }

        @Bean
        Bean1 bean1() {
            return new Bean1(common());
        }

        @Bean
        Bean2 bean2() {
            return new Bean2(common());
        }
    }

    static class Bean1 {
        private final Common common;

        Bean1(Common common) {
            System.out.println("Bean1's common : "+common);
            this.common = common;
        }
    }

    static class Bean2 {
        private final Common common;

        Bean2(Common common) {
            System.out.println("Bean2's common : "+common);
            this.common = common;
        }
    }
}
```

**1. MyConfig.classë¥¼ ì¸ìŠ¤í„´ìŠ¤ í•œ ë’¤ì—, ê° í•¨ìˆ˜ë¡œ ë¶€í„° Bean1, Bean2 í´ë˜ìŠ¤ ì°¸ì¡°ë³€ìˆ˜ë¥¼ ë°›ì•„ ì˜¨ ë’¤, ë¹„êµ í…ŒìŠ¤íŠ¸**

```java
@Test
void configuration() {
    MyConfig myConfig = new MyConfig();
    Bean1 bean1 = myConfig.bean1();
    Bean2 bean2 = myConfig.bean2();

    assertThat(bean1.common).isSameAs(bean2.common);
}
```
>  **í…ŒìŠ¤íŠ¸ ê²°ê³¼ : ì‹¤íŒ¨(ë‘ ê°ì²´ì˜ ì£¼ì†Œê°’ì´ ë‹¤ë¦„)**

í…ŒìŠ¤íŠ¸ ê²°ê³¼ê°€ ì‹¤íŒ¨ê°€ ë˜ëŠ” ì´ìœ ëŠ” new Common()ì´ ë‘ ë²ˆ í˜¸ì¶œ ë˜ë©´ì„œ ë‹¤ë¥¸ ì£¼ì†Œì˜ Common ê°ì²´ê°€ ìƒì„±ì´ ë˜ì—ˆê¸° ë•Œë¬¸ì´ë‹¤.

- ì¶œë ¥ ê²°ê³¼

```
new Common() : 1íšŒ í˜¸ì¶œ
Common ì£¼ì†Œ : tobyspring.helloboot.Common@8b87145
Bean1's common : tobyspring.helloboot.Common@8b87145
new Common() : 2íšŒ í˜¸ì¶œ
Common ì£¼ì†Œ : tobyspring.helloboot.Common@6483f5ae
Bean2's common : tobyspring.helloboot.Common@6483f5ae
```

**2. MyConfig.classë¥¼ ApplicationContextì— ë¹ˆìœ¼ë¡œ ë“±ë¡ í›„, í…ŒìŠ¤íŠ¸**

```java
@Test
void configuration() {
    AnnotationConfigApplicationContext ac = new AnnotationConfigApplicationContext();
    ac.register(MyConfig.class);
    ac.refresh();

    Bean1 bean1 = ac.getBean(Bean1.class);
    Bean2 bean2 = ac.getBean(Bean2.class);

    // isSameAs : ê°™ì€ ì˜¤ë¸Œì íŠ¸ì¸ì§€ ì£¼ì†Œê°’ê¹Œì§€ ë¹„êµ
    assertThat(bean1.common).isSameAs(bean2.common);
    // í…ŒìŠ¤íŠ¸ í†µê³¼
}
```

> **í…ŒìŠ¤íŠ¸ ê²°ê³¼ : ì„±ê³µ(ë‘ ê°ì²´ì˜ ì£¼ì†Œê°’ì´ ê°™ìŒ)**

í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µìœ¼ë¡œ ì´ì–´ì§„ ì´ìœ ëŠ” new Common()ì´ ë”± í•œ ë²ˆ í˜¸ì¶œ ë˜ë©´ì„œ, ìƒì„±ëœ Common beanì„ ì‹±ê¸€í†¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¡œ ë“±ë¡í•˜ì—¬ ì‚¬ìš©í–ˆê¸° ë•Œë¬¸ì´ë‹¤.

- 01.SpringBoot WEB ë™ì‘ì›ë¦¬ì—ì„œ ì‹±ê¸€í†¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì— ëŒ€í•´ ì–¸ê¸‰í•œ ë‚´ìš© ë‹¤ì‹œ ë³´ê¸°

> ìŠ¤í”„ë§ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œëŠ” ì‹±ê¸€í†¤ íŒ¨í„´ê³¼ ìœ ì‚¬í•˜ê²Œ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ë™ì‘í•˜ëŠ” ë™ì•ˆ ë”± **í•˜ë‚˜ì˜ ì˜¤ë¸Œì íŠ¸ë§Œ**ì„ ë§Œë“¤ê³  ì‚¬ìš©ë˜ê²Œ ë§Œë“¤ì–´ ì¤€ë‹¤. ì´ëŸ° ë©´ì—ì„œ ìŠ¤í”„ë§ ì»¨í…Œì´ë„ˆëŠ” **ì‹±ê¸€í†¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬**ë¼ê³  í•œë‹¤.

- ì¶œë ¥ ê²°ê³¼

```
DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean 'configurationTest.MyConfig'

DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean 'common'

new Common() : 1íšŒ í˜¸ì¶œ
Common ì£¼ì†Œ : tobyspring.helloboot.Common@f78a47e

Creating shared instance of singleton bean 'bean1'

Creating shared instance of singleton bean 'bean2'


Bean1's common : tobyspring.helloboot.Common@f78a47e
Bean2's common : tobyspring.helloboot.Common@f78a47e
```

**ğŸ¤” ìŠ¤í”„ë§ì€ ì™œ ì‹±ê¸€í†¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ ê³ ì§‘í• ê¹Œ? ê·¸ë¦¬ê³  ì–´ë–»ê²Œ ì‹±ê¸€í†¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ ìœ ì§€í•  ìˆ˜ ìˆëŠ” ê²ƒì¼ê¹Œ?**

1. ìŠ¤í”„ë§ì€ í•œ ê°œì˜ ì˜¤ë¸Œì íŠ¸ë§Œ ì‚¬ìš©í•˜ê²Œ ë˜ëŠ”ë°, ë§Œì•½ í•˜ë‚˜ì˜ ë¹ˆì„ ë‘ ê°œ ì´ìƒì˜ ë‹¤ë¥¸ ë¹ˆì—ì„œ ì˜ì¡´í•˜ê³  ìˆë‹¤ë©´ FactoryMethodë¥¼ í˜¸ì¶œí•  ë•Œë§ˆë‹¤, ìƒˆë¡œìš´ ë¹ˆì´ ë§Œë“¤ì–´ì§€ëŠ” ë¬¸ì œê°€ ìƒê¸´ë‹¤.

2. ìŠ¤í”„ë§ì€ ì´ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ @Configuration ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì€ í´ë˜ìŠ¤ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ Proxyë¥¼ ë§Œë“¤ì–´ì„œ ì´ë¥¼ í•´ê²°í•´ì¤€ë‹¤

> âœ”ï¸ ì²˜ìŒ í…ŒìŠ¤íŠ¸ í–ˆë˜ ì½”ë“œì— Proxy ê¸°ëŠ¥ì„ ë§Œë“¤ì–´ì„œ ìˆ˜ì •í•œ ë’¤, ë‹¤ì‹œ ì§„í–‰í•´ë³´ë„ë¡ í•œë‹¤.

**3. MyConfigProxy.classë¥¼ ì¸ìŠ¤í„´ìŠ¤ í•œ ë’¤ì—, ê° í•¨ìˆ˜ë¡œ ë¶€í„° Bean1, Bean2 í´ë˜ìŠ¤ ì°¸ì¡°ë³€ìˆ˜ë¥¼ ë°›ì•„ ì˜¨ ë’¤, ë¹„êµ í…ŒìŠ¤íŠ¸**

```java
// ì¶”ê°€ëœ ë¶€ë¶„
static class MyConfigProxy extends MyConfig {
    private Common common;

    @Override
    Common common() {
        if (this.common == null) this.common = super.common();
             return this.common;
    }
}

// Test
@Test
void configuration() {
    MyConfigProxy myConfigProxy = new MyConfigProxy();
    Bean1 bean1 = myConfigProxy.bean1();
    Bean2 bean2 = myConfigProxy.bean2();
    assertThat(bean1.common).isSameAs(bean2.common);
    // í…ŒìŠ¤íŠ¸ í†µê³¼
}
```

> **í…ŒìŠ¤íŠ¸ ê²°ê³¼ : ì„±ê³µ(ë‘ ê°ì²´ì˜ ì£¼ì†Œê°’ì´ ê°™ìŒ)**

- ì¶œë ¥ ê²°ê³¼

```
new Common() : 1íšŒ í˜¸ì¶œ
Common ì£¼ì†Œ : tobyspring.helloboot.Common@8b87145
Bean1's common : tobyspring.helloboot.Common@8b87145
Bean2's common : tobyspring.helloboot.Common@8b87145
```


### **4.3.2. @Configuration(proxyBeanMethods = false)ë¡œ ì„¤ì • í›„, ì‹±ê¸€í†¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ í…ŒìŠ¤íŠ¸**

ì´ë²ˆì—ëŠ” ë°˜ëŒ€ë¡œ, ì‹±ê¸€í†¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ í†µí•´ ì„±ê³µí–ˆë˜ í…ŒìŠ¤íŠ¸ì˜ @Configurtion ì†ì„±ê°’ì— proxyBeanMethods = falseë¡œ ì„¤ì •í•˜ê³  2ë²ˆì§¸ í–ˆë˜ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•´ë³´ë„ë¡ í•˜ì.

```java
// ìˆ˜ì •ëœ ë¶€ë¶„
@Configuration(proxyBeanMethods = false)
static class MyConfig {
    ...
}

@Test
void configuration() {
    AnnotationConfigApplicationContext ac = new AnnotationConfigApplicationContext();
    ac.register(MyConfig.class);
    ac.refresh();

    Bean1 bean1 = ac.getBean(Bean1.class);
    Bean2 bean2 = ac.getBean(Bean2.class);

    // isSameAs : ê°™ì€ ì˜¤ë¸Œì íŠ¸ì¸ì§€ ì£¼ì†Œê°’ê¹Œì§€ ë¹„êµ
    assertThat(bean1.common).isSameAs(bean2.common);
    // í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨
}
```

proxyBeanMethods = trueì—ì„œ falseë¡œ ë°”ê¾¸ì ì‹¤íŒ¨í•œ ì´ìœ ëŠ” @Configurationì´ ë¶™ì€ í´ë˜ìŠ¤ë¥¼ ë¹ˆìœ¼ë¡œ ë“±ë¡ í•  ë•Œ, Proxyë¥¼ ë§Œë“¤ì§€ ì•Šê³ , ìë°” ì½”ë“œ ê·¸ëŒ€ë¡œ ë™ì‘í•˜ê²Œ ë§Œë“¤ì—ˆê¸° ë•Œë¬¸ì´ë‹¤.

- ì¶œë ¥ ê²°ê³¼

```
Creating shared instance of singleton bean 'configurationTest.MyConfig'

DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean 'common'

new Common() : 1íšŒ í˜¸ì¶œ

Common ì£¼ì†Œ : tobyspring.helloboot.Common@625732

DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean 'bean1'

new Common() : 2íšŒ í˜¸ì¶œ
Common ì£¼ì†Œ : tobyspring.helloboot.Common@51dcb805
Bean1's common : tobyspring.helloboot.Common@51dcb805

DEBUG org.springframework.beans.factory.support.DefaultListableBeanFactory - Creating shared instance of singleton bean 'bean2'

new Common() : 3íšŒ í˜¸ì¶œ
Common ì£¼ì†Œ : tobyspring.helloboot.Common@66498326
Bean2's common : tobyspring.helloboot.Common@66498326
```

ì•„ê¹Œì™€ëŠ” ë‹¤ë¥´ê²Œ, commonì´ ì‹±ê¸€í†¤ ë¹ˆìœ¼ë¡œ ë“±ë¡ ë˜ì—ˆì§€ë§Œ, bean1()ê³¼ bean2() ë©”ì„œë“œì—ì„œ new Common()ì„ ê°ê° í˜¸ì¶œí•˜ë©´ì„œ ë‹¤ë¥¸ ê°ì²´ë¥¼ í• ë‹¹ ë°›ì€ ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.

### **4.3.3. @Configuration(proxyBeanMethods = false)ë¡œ ì‹¤ì œ í™œìš© ì˜ˆì‹œ**

- @EnableScheduling
```java
@Target({ElementType.TYPE})
@Retention(RetentionPolicy.RUNTIME)
@Import({SchedulingConfiguration.class})
@Documented
public @interface EnableScheduling {
}
```
- SchedulingConfiguration.class
```java
@Configuration(
    proxyBeanMethods = false
)
@Role(2)
public class SchedulingConfiguration {
    public SchedulingConfiguration() {
    }
    @Bean(
        name = {"org.springframework.context.annotation.internalScheduledAnnotationProcessor"}
    )
    @Role(2)
    public ScheduledAnnotationBeanPostProcessor scheduledAnnotationProcessor() {
        return new ScheduledAnnotationBeanPostProcessor();
    }
}
```

SchedulingConfiguration ì†ŒìŠ¤ ì½”ë“œë¥¼ ë³´ë©´, Beanì„ í•˜ë‚˜ ìƒì„±í•˜ëŠ” ì½”ë“œê°€ ìˆëŠ”ë°, 
í•´ë‹¹ Beanì€ ìƒì„±í•˜ëŠ” ë™ì•ˆì—, ë‹¤ë¥¸ ì˜¤ë¸Œì íŠ¸ë¥¼ ì˜ì¡´í•˜ê³  ìˆì§€ ì•Šë‹¤.


ì´ëŸ° ê²½ìš°, ë§¤ë²ˆ Proxyë¥¼ ë§Œë“¤ì–´ì„œ ì ìš©í•   í•„ìš”ê°€ ì—†ë‹¤ê³  íŒë‹¨í•˜ì—¬ proxyBeanMethodsë¥¼ falseë¡œ ì„¤ì •í•œ ì¼€ì´ìŠ¤ì´ë‹¤.